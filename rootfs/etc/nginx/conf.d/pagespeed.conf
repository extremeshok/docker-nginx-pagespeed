# disable pagespeed to activate it on each vhost
pagespeed standby;

# Disable for ajax
pagespeed Disallow */?*ajax=*;
pagespeed Disallow */?*ajax=*;

# Disable for admin
pagespeed Disallow */acp/*;
pagespeed Disallow */admin/*;
pagespeed Disallow */backend/*;
pagespeed Disallow */wp-admin/*;

# Pagespeed admin pages
pagespeed AdminPath /pagespeed_admin;
pagespeed GlobalAdminPath /pagespeed_global_admin;
pagespeed ConsolePath /pagespeed_console;
pagespeed MessagesPath /ngx_pagespeed_message;
pagespeed StatisticsPath /ngx_pagespeed_statistics;
pagespeed GlobalStatisticsPath /ngx_pagespeed_global_statistics;

# Pagespeed console, logging and stats
pagespeed Statistics On;
pagespeed LogDir "/var/cache/pagespeed/log";
pagespeed StatisticsLogging on;
pagespeed MessageBufferSize 100000;
pagespeed StatisticsLoggingIntervalMs 60000;
pagespeed StatisticsLoggingMaxFileSizeKb 1024;

# File caching
pagespeed FileCachePath "/var/cache/pagespeed";
# 10 GB
pagespeed FileCacheSizeKb 10240000000;
pagespeed FileCacheInodeLimit 5000000;
# Clean the cache every 365 days
pagespeed FileCacheCleanIntervalMs 31557600000;

# 64MByte shared cache
pagespeed DefaultSharedMemoryCacheKB 65536;
pagespeed CreateSharedMemoryMetadataCache "/var/cache/pagespeed" 65536;


#######################################################
# By default, ngx_pagespeed adds an X-PageSpeed header with a value of the version of
# ngx_pagespeed being used. This directive lets you specify the value to use instead:
pagespeed XHeaderValue "powered by eXtremeSHOK.com";

# Honor Content-Security-Policy Headers
pagespeed HonorCsp on;

pagespeed NoTransformOptimizedImages on;
pagespeed ProcessScriptVariables on;
pagespeed PreserveUrlRelativity on;

pagespeed EnableFilters extend_cache;

# optimize the content of a resource that's requested using the original (non-pagespeed) URL
# will slow the page down.. (will not use the pagespeed file names)
pagespeed InPlaceResourceOptimization off;

#######################################################
# Purge nginx pagespeed cache
# https://developers.google.com/speed/pagespeed/module/system#flush_cache
#######################################################
pagespeed EnableCachePurge on;
pagespeed PurgeMethod PURGE;

# httpS support
pagespeed SslCertDirectory "/etc/ssl/certs";
pagespeed FetchHttps enable,allow_self_signed,allow_unknown_certificate_authority,allow_certificate_not_yet_valid;

pagespeed RespectVary off;
pagespeed MaxCombinedCssBytes -1;

# use a beacon to collect information about the rewritten page so as to optimize the rewriting process
pagespeed CriticalImagesBeaconEnabled true;
pagespeed EnableFilters lazyload_images;
pagespeed EnableFilters inline_preview_images;
pagespeed EnableFilters inline_images;


pagespeed ImageResolutionLimitBytes 16777216;


pagespeed CacheFlushPollIntervalSec 0;
pagespeed HttpCacheCompressionLevel 6;

pagespeed CssImageInlineMaxBytes 0;
pagespeed ImageInlineMaxBytes 3072;
pagespeed MaxInlinedPreviewImagesIndex -1;
pagespeed MinImageSizeLowResolutionBytes 3072;

# https://developers.google.com/speed/pagespeed/module/reference-image-optimize#JpegQualityForSaveData
pagespeed JpegQualityForSaveData 50;

# https://developers.google.com/speed/pagespeed/module/reference-image-optimize#WebpQualityForSaveData
pagespeed WebpQualityForSaveData 50;

# https://developers.google.com/speed/pagespeed/module/filter-image-optimize#WebpRecompressionQuality
pagespeed WebpRecompressionQuality 75;

pagespeed ForbidAllDisabledFilters true;

# Required for redis operation
pagespeed LRUCacheKbPerProcess 16384;
pagespeed LRUCacheByteLimit 32768;


pagespeed MaxSegmentLength 500;

# optimization filters
pagespeed RewriteLevel CoreFilters;
pagespeed EnableFilters extend_cache;

# code related optimization
pagespeed EnableFilters remove_comments;
pagespeed EnableFilters collapse_whitespace;

# DNS related optimization
pagespeed EnableFilters insert_dns_prefetch;

# save on bandwidth and load resources directly from file system
pagespeed UseNativeFetcher on;
pagespeed FetcherTimeoutMs 500;
pagespeed FetchWithGzip off;
pagespeed RateLimitBackgroundFetches off;
pagespeed RewriteDeadlinePerFlushMs 500;

#######################################################
# https://developers.google.com/speed/pagespeed/module/system#tune_thread
pagespeed NumRewriteThreads 4;
pagespeed NumExpensiveRewriteThreads 4;
pagespeed ImageMaxRewritesAtOnce 4;

#7days
pagespeed ImplicitCacheTtlMs 604800000;

# image related optimization
pagespeed EnableFilters resize_images;
pagespeed EnableFilters rewrite_images;
pagespeed EnableFilters jpeg_subsampling;
pagespeed EnableFilters responsive_images;
pagespeed EnableFilters responsive_images_zoom;
pagespeed EnableFilters convert_gif_to_png;
pagespeed EnableFilters strip_image_meta_data;
pagespeed EnableFilters strip_image_color_profile;
pagespeed EnableFilters convert_jpeg_to_progressive;
pagespeed EnableFilters dedup_inlined_images;
pagespeed EnableFilters resize_mobile_images;
pagespeed EnableFilters inline_images;
pagespeed EnableFilters recompress_jpeg;
pagespeed EnableFilters recompress_png;
pagespeed EnableFilters recompress_webp;
pagespeed EnableFilters resize_rendered_image_dimensions;
pagespeed EnableFilters convert_jpeg_to_webp;
pagespeed EnableFilters convert_to_webp_lossless;
pagespeed EnableFilters convert_to_webp_animated;
pagespeed EnableFilters sprite_images;

# javascript related optimization
#pagespeed EnableFilters rewrite_javascript;
#pagespeed EnableFilters inline_javascript;
#pagespeed EnableFilters combine_javascript;
## DO NOT ENABLE breaks most websites
#pagespeed EnableFilters defer_javascript;

#pagespeed MaxCombinedJsBytes 276480;
pagespeed EnableFilters canonicalize_javascript_libraries;
pagespeed AvoidRenamingIntrospectiveJavascript on;

# css style sheets related optimization
pagespeed EnableFilters inline_css;
pagespeed EnableFilters rewrite_css;
pagespeed EnableFilters combine_css;
pagespeed EnableFilters outline_css;
pagespeed EnableFilters flatten_css_imports;
pagespeed EnableFilters prioritize_critical_css;
pagespeed EnableFilters inline_import_to_link;
pagespeed EnableFilters move_css_above_scripts;
pagespeed EnableFilters move_css_to_head;
pagespeed EnableFilters fallback_rewrite_css_urls;
pagespeed EnableFilters rewrite_style_attributes_with_url;

# google font optimisations
pagespeed EnableFilters inline_google_font_css;
pagespeed GoogleFontCssInlineMaxBytes 5000;
# include google fonts and serve them from our server
#pagespeed Domain  https://fonts.gstatic.com;
#pagespeed Domain  https://fonts.googleapis.com/*;
